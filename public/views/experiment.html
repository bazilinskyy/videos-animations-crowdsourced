<!doctype html>
<html>
  <head>
    <title>Videos of eHMI from Unity</title>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
    <script src='jsPsych/jspsych.js'></script>
    <script src='jsPsych/plugins/jspsych-html-keyboard-response.js'></script>
    <script src='jsPsych/plugins/jspsych-video-keyboard-multiple-responses-release.js'></script>
    <script src='jsPsych/plugins/jspsych-html-slider-response.js'></script>
    <script src='jsPsych/plugins/jspsych-call-function.js'></script>
    <link href='jsPsych/css/jspsych.css' rel='stylesheet' type='text/css'></link>
    <link href='css/experiment.css' rel='stylesheet' type='text/css'></link>
    <link rel='icon' type='image/png' href='/img/favicon.png' />
  </head>
  <body>
  </body>
  <script>
// by Pavlo Bazilinskyy <p.bazilinskyy@tudelft.nl>

// Constants
var n_videos = 56; // number of videos
var n_videos_per_block = 4; // number of videos in each block
var video_pfefix = 'videos/video_'; // prefix for videos

/**
* Returns a random integer between min (inclusive) and max (inclusive).
* The value is no lower than min (or the next integer greater than min
* if min isn't an integer) and no greater than max (or the next integer
* lower than max if max isn't an integer).
* Using Math.round() will give you a non-uniform distribution!
*/
function getRandomInt(min, max) {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

/**
 * Get finish code for the worker.
 */
function getFinishCode() {
    var timestamp = window.performance.timing.navigationStart + window.performance.now();
    var current_time = Math.round(timestamp);
    var random_num = getRandomInt(1, 10000);
    finish_code = 'Q6' + current_time + 'BV' + random_num + '2M';
    return finish_code;
}

var finish_code = getFinishCode();

/**
 * Shuffles array in place.
 * @param {Array} a items An array containing the items.
 */
function shuffle(a) {
    var j, x, i;
    for (i = a.length - 1; i > 0; i--) {
        j = Math.floor(Math.random() * (i + 1));
        x = a[i];
        a[i] = a[j];
        a[j] = x;
    }
    return a;
}

var group_choice = getRandomInt(0, 1);  // group


// Arrays for storing data
var video_ids_1 = [];  // IDs of videos in stimuli in 1st part
var video_ids_2 = [];  // IDs of videos in stimuli in 2nd part
var between_blocks = []; // instructions between blocks
var video_stimuli = []; // blocks with videos

// define instructions block
var instructions_block = {
    type: 'html-keyboard-response',
    stimulus: '<p>The purpose of this experiment is to determine if the movement of an automated vehicle can be used to communicate if it is going to stop for a pedestrian. In the following videos, you will see an automated vehicle deviate within its lane as it approaches you. The direction of the deviation indicates whether it intends to stop or keep going. Your task will be to hold a response key if you feel safe to cross.</p><p>You will view 28 animations. Press \'F\' when you feel safe to cross the road in front of the car. You can release the button and then press it again multiple times during the video. After each 4 videos you will be able to take a small break. The window of your browser should be at least 1300px wide and 800px tall. Press \'C\' to start the first video.</p>',
    choices: ['C'],
};
// populate arrays with video IDs
for (var i = 1; i <= n_videos/2; i++) {
    video_ids_1.push(i);
}
for (var i = n_videos/2 + 1; i <= n_videos; i++) {
    video_ids_2.push(i);
}
// shuffle array with video IDs
if (group_choice == 1) {  // in group 1 first show videos from group 1 and then from group 2
	video_ids_1 = shuffle(video_ids_1);
	video_ids_2 = shuffle(video_ids_2);
} else if (group_choice == 2) {  // in group 2 first show videos from group 2 and then from group 1
	video_ids_1 = shuffle(video_ids_2);
	video_ids_2 = shuffle(video_ids_1);
} else {
	console.error('Wrong group id specified: ', group_choice);
}
console.log(group_choice);

// build array with videos with stimuli
for (var i = 0; i < n_videos; i++) {
    // check if group 1 or 2
    if (i < n_videos / 2) { // group 1
        video_id = video_ids_1[i];
    } else {  //  group 2
        video_id = video_ids_2[i - n_videos / 2];
    }
    console.log(i, video_pfefix + video_id + '.mp4');
    video_stimuli.push({
        type: 'video-keyboard-multiple-responses-release',
        autoplay: true,
        controls: false,
        width: 1280,
        height: 720,
        choices: ['F'],
        sources: [video_pfefix + video_id + '.mp4'],
        prompt: '<p>Press and HOLD \'F\' when you feel safe to cross.</p>',
        on_finish: function(data) {
            jsPsych.data.addDataToLastTrial({
                worker_code: finish_code
            });
        }
    });
}
// black with text to continue before showing the image
var slider_block = {
    type: 'html-slider-response',
    labels: ['0', '20', '40', '60', '80', '100'],
    stimulus: '<p></p>',
    slider_width: 1000,
    // labels: ['Not intuitive at all', 'Completely intuitive'],
    prompt: "<p style='width: 1000px'>Please rate the following statement: <strong>The behaviour of the car in the previous video is intuitive for signaling \'Please cross the road\'</strong> (0 = completely disagree, 100 = completely agree).</p>",
    require_movement: true
};
// build between blocks
for (var i = 1; i <= n_videos / n_videos_per_block - 1; i++) {
    var videos_done = n_videos_per_block * i;
    between_blocks.push({
        type: 'html-keyboard-response',
        stimulus: '<p>You have now completed ' + videos_done + ' videos out of ' + n_videos + '. When ready press \'C\' to proceed to the next batch.</p>',
        choices: ['C']
    });
}
// block for sending data
var save_data_block = {
    type: 'call-function',
    func: function() {
        $.ajax({
                type: 'POST',
                url: '/experiment-data',
                data: jsPsych.data.get().json(),
                contentType: 'application/json'
            })
            .done(function() {
                jsPsych.data.reset();
            })
            .fail(function() {
                alert('A problem occurred while writing to the database. Please contact the researcher for more information.')
                window.location.href = '/';
            })
    }
}
// create experiment timeline array
var timeline = [];
timeline.push(instructions_block);
// iterate over blocks
for (var i = 0; i < n_videos / n_videos_per_block; i++) {
    // iterate over videos per block
    for (var j = 0; j < n_videos_per_block; j++) {
        // check if it's the last block and no more videos are needed
        if (i * n_videos_per_block + j < n_videos) {
            timeline.push(video_stimuli[i * n_videos_per_block + j]);  // page with the stimulus
            timeline.push(slider_block);
            console.log(i, j, i * n_videos_per_block + j, video_stimuli[i * n_videos_per_block + j]);
        }
    }
    // save data
    timeline.push(save_data_block);
    // don't add the between block after the last trial
    if (i != n_videos / n_videos_per_block - 1) {
      timeline.push(between_blocks[i]);
    }
}
console.log(video_ids_1);
console.log(video_ids_2);
console.log(between_blocks);
console.log(video_stimuli);
console.log(timeline);
/* Start the experiment */
jsPsych.init({
  // auto_preload: false,
    show_preload_progress_bar: true,
    timeline: timeline,
    max_load_time: 3000000,
    on_finish: function() {
        window.location.href = 'finish?work=' + finish_code;
    }
});
</script>
</html>
